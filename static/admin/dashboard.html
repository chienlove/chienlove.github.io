<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
  
  <script>
    const DebugUpdateSizeControl = createClass({
  getInitialState() {
    return {
      inputValue: this.props.value || '',
      debugMessage: ''
    };
  },

  handleInputChange(e) {
    this.setState({ inputValue: e.target.value });
  },

  setDebugMessage(message) {
    this.setState({ debugMessage: message });
    console.log(message); // Log để dễ dàng debug
  },

  handleUpdateSize: async function() {
    this.setDebugMessage('Bắt đầu cập nhật kích thước...');
    
    const plistUrlInput = document.querySelector('[name="main_download.plistUrl"]');
    if (!plistUrlInput) {
      this.setDebugMessage('Không tìm thấy trường URL Plist');
      return;
    }

    const plistUrl = plistUrlInput.value;
    if (!plistUrl) {
      this.setDebugMessage('URL Plist trống. Vui lòng nhập URL Plist trước');
      return;
    }

    this.setDebugMessage('Đang gọi API để lấy kích thước...');
    try {
      const response = await fetch(`/.netlify/functions/getIpaSize?url=${encodeURIComponent(plistUrl)}`);
      const data = await response.json();
      
      if (data.size) {
        this.setDebugMessage(`Kích thước nhận được: ${data.size}`);
        this.props.onChange(data.size);
        this.setState({ inputValue: data.size });
      } else if (data.error) {
        this.setDebugMessage(`Lỗi: ${data.error}`);
      } else {
        this.setDebugMessage('Không nhận được kích thước hợp lệ từ API');
      }
    } catch (error) {
      this.setDebugMessage(`Lỗi khi gọi API: ${error.message}`);
    }
  },

  render: function() {
    const { forID, classNameWrapper } = this.props;
    return h('div', { className: classNameWrapper },
      h('input', {
        type: 'text',
        id: forID,
        className: 'debug-update-size-input',
        value: this.state.inputValue,
        onChange: this.handleInputChange,
        style: { width: '200px' }
      }),
      h('button', {
        className: 'debug-update-size-button',
        onClick: this.handleUpdateSize,
        style: { marginLeft: '10px' }
      }, 'Cập nhật kích thước'),
      h('div', { style: { marginTop: '10px', color: 'red' } }, this.state.debugMessage)
    );
  }
});

CMS.registerWidget('update-size', DebugUpdateSizeControl);

    // Khởi tạo CMS
    CMS.init();
  </script>
</body>
</html>