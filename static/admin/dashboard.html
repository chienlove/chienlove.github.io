<!DOCTYPE html>
<html>
<head>
  <title>Netlify CMS Admin</title>
  <link rel="stylesheet" href="css/admin.css">
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
  <style>
    .netlify-identity-button {
      display: none !important;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
  <script>
    // Hàm gọi API Netlify Function để lấy kích thước file IPA
    const fetchFileSize = async (plistUrl) => {
      try {
        const response = await fetch(`/api/getIpaSize?url=${encodeURIComponent(plistUrl)}`);
        const data = await response.json();
        if (data.size) {
          console.log('Kích thước nhận từ API:', data.size);
          return data.size;
        } else {
          console.error('Không thể lấy kích thước từ API');
          return null;
        }
      } catch (error) {
        console.error('Lỗi khi gọi API:', error);
        return null;
      }
    };

    // Widget tùy chỉnh cho nút "Cập nhật kích thước"
    const SizeUpdateControl = createClass({
      handleClick: async function() {
        const { value, forID, setActiveStyle, setInactiveStyle, entry, onChange } = this.props;

        // Lấy URL plist từ entry
        const mainDownload = entry.getIn(['data', 'main_download']);
        if (mainDownload && mainDownload.get('plistUrl')) {
          const plistUrl = mainDownload.get('plistUrl');
          console.log('URL plist:', plistUrl);

          const fileSize = await fetchFileSize(plistUrl);  // Gọi API để lấy kích thước

          if (fileSize) {
            onChange(fileSize);  // Cập nhật giá trị kích thước
            alert('Kích thước đã được cập nhật: ' + fileSize);
          } else {
            alert('Không thể cập nhật kích thước file');
          }
        } else {
          alert('URL plist không tồn tại');
        }
      },

      render: function() {
        return h('div', {},
          h('button', { type: 'button', onClick: this.handleClick }, 'Cập nhật kích thước')
        );
      }
    });

    CMS.registerWidget('update-size', SizeUpdateControl);

    // Khởi tạo CMS với cấu hình
    CMS.init({
      config: {
        backend: {
          name: 'git-gateway',
        },
      },
    });
  </script>
</body>
</html>