<!DOCTYPE html>
<html>
<head>
  <title>Netlify CMS Admin</title>
  <link rel="stylesheet" href="css/admin.css">
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
  <style>
    .netlify-identity-button {
      display: none !important;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
  <script>
    // Hàm lấy kích thước file từ API
    const updateFileSize = async (entry) => {
      const mainDownload = entry.getIn(['data', 'main_download']);
      
      // Kiểm tra nếu 'main_download' không tồn tại
      if (!mainDownload) {
        console.error('main_download không tồn tại');
        return;
      }

      const plistUrl = mainDownload.get('plistUrl');
      if (!plistUrl) {
        console.error('plistUrl không tồn tại');
        return;
      }

      console.log(`Đang lấy kích thước từ URL: ${plistUrl}`);

      try {
        const response = await fetch(`/api/getIpaSize?url=${encodeURIComponent(plistUrl)}`);
        const data = await response.json();
        console.log('API response:', data); // Kiểm tra phản hồi API

        if (data.size) {
          // Cập nhật kích thước file
          entry = entry.setIn(['data', 'size'], data.size);
          console.log('Cập nhật kích thước:', data.size);
        } else {
          throw new Error(data.error || 'Không thể lấy kích thước file');
        }
      } catch (error) {
        console.error(`Lỗi: ${error.message}`);
        entry = entry.setIn(['data', 'size'], 'Không thể lấy kích thước');
      }

      return entry; // Trả lại entry đã cập nhật
    };

    // Đăng ký sự kiện preSave để cập nhật kích thước file trước khi lưu
    CMS.registerEventListener({
      name: 'preSave',
      handler: async ({ entry }) => {
        console.log('Sự kiện preSave kích hoạt');
        const updatedEntry = await updateFileSize(entry);
        return updatedEntry; // Trả lại entry đã cập nhật cho sự kiện preSave
      },
    });

    // Đăng ký sự kiện change để cập nhật kích thước khi plistUrl thay đổi
    CMS.registerEventListener({
      name: 'change',
      handler: ({ entry }) => {
        console.log('Sự kiện change kích hoạt');
        if (entry.getIn(['data', 'main_download']) && entry.getIn(['data', 'main_download', 'plistUrl'])) {
          updateFileSize(entry);
        }
      },
    });

    // Đăng ký sự kiện load để cập nhật kích thước khi bài viết cũ được mở
    CMS.registerEventListener({
      name: 'load',
      handler: async ({ entry }) => {
        console.log('Sự kiện load kích hoạt');
        if (entry.getIn(['data', 'main_download']) && entry.getIn(['data', 'main_download', 'plistUrl'])) {
          const updatedEntry = await updateFileSize(entry);
          return updatedEntry; // Trả lại entry đã cập nhật cho sự kiện load
        }
      },
    });

    // Khởi tạo CMS với cấu hình
    CMS.init({
      config: {
        backend: {
          name: 'git-gateway',
        },
      },
    });
  </script>
</body>
</html>