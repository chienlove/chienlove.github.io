<!DOCTYPE html>
<html>
<head>
  <title>Netlify CMS Admin</title>
  <link rel="stylesheet" href="css/admin.css">
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
  <style>
    .netlify-identity-button {
      display: none !important;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
  <script>
CMS.registerPreviewStyle("https://unpkg.com/@tailwindcss/typography@0.4.x/dist/typography.min.css");
CMS.registerPreviewStyle("https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css");

CMS.init({
  config: {
    backend: {
      name: 'git-gateway'
    }
  }
});

const updateFileSize = async (entry) => {
  const plistUrl = entry.get('main_download').get('plistUrl');
  if (!plistUrl) return;

  try {
    const response = await fetch(`/.netlify/functions/getIpaSize?url=${encodeURIComponent(plistUrl)}`);
    const data = await response.json();
    if (data.size) {
      entry.get('data').set('size', data.size);
    } else {
      throw new Error(data.error || 'Không thể lấy kích thước file');
    }
  } catch (error) {
    console.error(`Lỗi: ${error.message}`);
    entry.get('data').set('size', 'Không thể lấy kích thước');
  }
};

CMS.registerEventListener({
  name: 'preSave',
  handler: async ({ entry }) => {
    await updateFileSize(entry);
  },
});

CMS.registerEventListener({
  name: 'change',
  handler: ({ entry }) => {
    if (entry.get('main_download') && entry.get('main_download').get('plistUrl')) {
      updateFileSize(entry);
    }
  },
});
</script></body>
</html>