<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
  
  <script>
    // Hàm gọi API Netlify Function để lấy kích thước file IPA
    const fetchFileSize = async (plistUrl) => {
      try {
        console.log('Gọi API để lấy kích thước với URL:', plistUrl);
        const response = await fetch(`/.netlify/functions/getIpaSize?url=${encodeURIComponent(plistUrl)}`);
        const data = await response.json();
        if (data.size) {
          console.log('API trả về kích thước:', data.size);
          return data.size;
        } else {
          console.error('API không trả về kích thước hợp lệ');
          return null;
        }
      } catch (error) {
        console.error('Lỗi khi gọi API:', error);
        return null;
      }
    };

    // Widget tùy chỉnh cho nút "Cập nhật kích thước"
    const UpdateSizeControl = createClass({
      handleUpdateSize: async function() {
        const { value, onChange, forID, field } = this.props;
        const plistUrl = document.querySelector('[name="main_download.plistUrl"]').value;
        if (!plistUrl) {
          alert('Vui lòng nhập URL Plist trước');
          return;
        }

        const fileSize = await fetchFileSize(plistUrl);
        if (fileSize) {
          onChange(fileSize);
          alert('Kích thước đã được cập nhật: ' + fileSize);
        } else {
          alert('Không thể cập nhật kích thước file');
        }
      },

      render: function() {
        const { value, onChange, forID, classNameWrapper, field } = this.props;
        return h('div', { className: classNameWrapper },
          h('input', {
            type: 'text',
            id: forID,
            className: 'update-size-input',
            value: value || '',
            onChange: e => onChange(e.target.value)
          }),
          h('button', {
            className: 'update-size-button',
            onClick: this.handleUpdateSize
          }, 'Cập nhật kích thước')
        );
      }
    });

    const UpdateSizePreview = createClass({
      render: function() {
        return h('div', {}, this.props.value);
      }
    });

    // Đăng ký widget tùy chỉnh
    CMS.registerWidget('update-size', UpdateSizeControl, UpdateSizePreview);

    // Khởi tạo CMS
    CMS.init();
  </script>
</body>
</html>