<!DOCTYPE html>
<html>
<head>
  <title>Netlify CMS Admin</title>
  <link rel="stylesheet" href="css/admin.css">
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    .netlify-identity-button {
      display: none !important;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
  <script>
  if (localStorage.getItem('netlify-cms-user')) {
    // Người dùng đã đăng nhập, khởi tạo CMS ngay lập tức
    window.CMS.init({
      config: {
        backend: {
          name: 'git-gateway'
        }
      }
    });
  } else if (window.netlifyIdentity) {
    window.netlifyIdentity.on("init", user => {
      if (!user) {
        window.location.href = "/admin";
      } else {
        window.CMS.init({
          config: {
            backend: {
              name: 'git-gateway'
            }
          }
        });
      }
    });
  }
</script>
  <script>CMS.registerWidget('fileSize', {
  // Hàm này render trường nhập liệu
  control: ({ value, onChange }) => {
    const [size, setSize] = React.useState(value || '');
    const [loading, setLoading] = React.useState(false);

    const updateSize = async () => {
      setLoading(true);
      const plistUrl = document.querySelector('[name="main_download.plistUrl"]').value;
      if (!plistUrl) {
        alert('Vui lòng nhập Plist URL trước');
        setLoading(false);
        return;
      }
      try {
        const response = await fetch(`/.netlify/functions/getIpaSize?url=${encodeURIComponent(plistUrl)}`);
        const data = await response.json();
        if (data.size) {
          setSize(data.size);
          onChange(data.size);
        } else {
          throw new Error(data.error || 'Không thể lấy kích thước file');
        }
      } catch (error) {
        alert(`Lỗi: ${error.message}`);
      }
      setLoading(false);
    };

    return h('div', {},
      h('input', {
        type: 'text',
        value: size,
        onChange: (e) => {
          setSize(e.target.value);
          onChange(e.target.value);
        },
        disabled: loading
      }),
      h('button', {
        onClick: updateSize,
        disabled: loading
      }, loading ? 'Đang cập nhật...' : 'Cập nhật kích thước')
    );
  },
  // Hàm này xác định giá trị được lưu
  fromBlock: (value) => value,
  // Hàm này xác định giá trị hiển thị trong preview
  toBlock: (value) => value,
});</script>
</body>
</html>