name: Deploy Firestore Indexes (manual, only 2 files)

on:
  workflow_dispatch:

jobs:
  deploy-indexes:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout (sparse: only 2 files)"
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            firebase.json
            firestore.indexes.json
          sparse-checkout-cone: false

      - name: "Sanity check"
        run: |
          echo "Repo root:"
          ls -la
          test -f firebase.json || (echo "❌ Missing firebase.json at repo root" && exit 1)
          test -f firestore.indexes.json || (echo "❌ Missing firestore.indexes.json at repo root" && exit 1)
          echo "✅ Found firebase.json & firestore.indexes.json"

      # Cấp thông tin xác thực Google theo chuẩn chính chủ
      - name: "Auth to Google Cloud"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          export_default_credentials: true

      - name: "Set up Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: "Install Firebase CLI"
        run: npm i -g firebase-tools

      - name: "Deploy Firestore Indexes only"
        env:
          # google-github-actions/auth đã set GOOGLE_APPLICATION_CREDENTIALS giúp ta
          CI: "true"
        run: |
          firebase --version
          firebase deploy \
            --only firestore:indexes \
            --project comments-storeios \
            --non-interactive