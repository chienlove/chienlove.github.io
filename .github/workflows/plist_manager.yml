name: Ultimate Plist Auto-Updater

on:
  schedule:
    - cron: '0 * * * *' # Cháº¡y hÃ ng giá»
  workflow_dispatch:
    inputs:
      force:
        description: 'Force update all plists'
        required: false
        default: 'false'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  NETLIFY_BUILD_HOOK: ${{ secrets.NETLIFY_BUILD_HOOK }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}

jobs:
  plist-updater:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # BÆ°á»›c 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # BÆ°á»›c 2: Thiáº¿t láº­p Node.js vÃ  cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # BÆ°á»›c 3: Äáº£m báº£o package.json tá»“n táº¡i
      - name: Ensure package.json exists
        run: |
          if [ ! -f package.json ]; then
            echo '{
              "name": "plist-updater",
              "version": "1.0.0",
              "dependencies": {
                "axios": "^1.6.7",
                "plist": "^3.1.0",
                "crypto-js": "^4.1.1",
                "dotenv": "^16.3.1"
              }
            }' > package.json
            git add package.json
          fi

      # BÆ°á»›c 4: Xá»­ lÃ½ package-lock.json thÃ´ng minh
      - name: Smart Package Lock Handling
        run: |
          # Äáº£m báº£o quyá»n ghi
          sudo chown -R $USER:$USER .
          
          # Táº¡o lock file náº¿u chÆ°a cÃ³
          if [ ! -f package-lock.json ]; then
            echo "ğŸ”„ Generating package-lock.json..."
            npm install --package-lock-only --no-audit --no-fund
          fi
          
          # CÃ i Ä‘áº·t dependencies
          npm ci --no-audit --no-fund || {
            echo "âš ï¸ Fallback to npm install..."
            rm -rf node_modules/
            npm install --no-audit --no-fund
          }

      # BÆ°á»›c 5: Kiá»ƒm tra dependencies
      - name: Verify Installation
        run: |
          echo "=== INSTALLATION VERIFICATION ==="
          ls -la
          npm list --depth=0

      # BÆ°á»›c 6: Cháº¡y plist updater
      - name: Run Plist Updater
        id: updater
        run: |
          FORCE_FLAG=${{ inputs.force == 'true' && '--force' || '' }}
          node ./scripts/plist-updater.js $FORCE_FLAG | tee output.log
          
          # TrÃ­ch xuáº¥t káº¿t quáº£
          echo "summary=$(grep 'SUMMARY:' output.log | cut -d' ' -f2-)" >> $GITHUB_OUTPUT
          echo "changed=$(grep 'CHANGED:' output.log | cut -d' ' -f2)" >> $GITHUB_OUTPUT
          echo "errors=$(grep 'ERRORS:' output.log | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      # BÆ°á»›c 7: Commit thay Ä‘á»•i
      - name: Commit Updates
        if: steps.updater.outputs.changed != '0'
        run: |
          git config --global user.name "GitHub Plist Bot"
          git config --global user.email "actions@github.com"
          git add .
          git diff --cached --quiet || git commit -m "ğŸ”„ Auto-update plist files [skip ci]"
          git push

      # BÆ°á»›c 8: KÃ­ch hoáº¡t Netlify Build
      - name: Trigger Netlify Deploy
        if: steps.updater.outputs.changed != '0'
        run: |
          curl -X POST -d {} "$NETLIFY_BUILD_HOOK"

      # BÆ°á»›c 9: ThÃ´ng bÃ¡o Telegram
      - name: Send Telegram Notification
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            *ğŸ“¢ Plist Update Report*
            â–«ï¸ *Status*: ${{ job.status }}
            â–«ï¸ *Changes*: ${{ steps.updater.outputs.changed || 0 }} files
            â–«ï¸ *Errors*: ${{ steps.updater.outputs.errors || 0 }}
            
            ğŸ“ *Summary*:
            ${{ steps.updater.outputs.summary || 'No changes detected' }}
            
            ğŸ” *Details*:
            [View Job](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown

      # BÆ°á»›c 10: Upload logs náº¿u lá»—i
      - name: Upload Debug Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: plist-updater-debug-logs
          path: |
            output.log
            npm-debug.log
