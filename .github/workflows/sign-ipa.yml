name: Sign IPA and Reupload

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag chứa IPA"
        required: true
      identifier:
        description: "Bundle Identifier mới"
        required: true

jobs:
  sign:
    runs-on: macos-latest

    env:
      GH_PAT: ${{ secrets.GH_PAT }}
      REPO: ${{ github.repository }}
      SUPABASE_URL: https://zkbzykamrzvvrhodiypk.supabase.co
      SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install tools
        run: |
          brew install curl jq gh

      - name: Fetch cert info from Supabase
        run: |
          curl -s "${SUPABASE_URL}/rest/v1/certificates?select=*" \
            -H "apikey: $SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SERVICE_ROLE_KEY" \
            | jq '.[0]' > cert.json

          echo "CERT_P12_URL=$(jq -r '.p12_url' cert.json)" >> $GITHUB_ENV
          echo "CERT_PROVISION_URL=$(jq -r '.provision_url' cert.json)" >> $GITHUB_ENV
          echo "CERT_PASSWORD=$(jq -r '.password' cert.json)" >> $GITHUB_ENV

      - name: Download certificates
        run: |
          curl -L "$CERT_P12_URL" -o cert.p12
          curl -L "$CERT_PROVISION_URL" -o profile.mobileprovision

      - name: Set environment variables
        run: |
          echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          echo "NEW_ID=${{ github.event.inputs.identifier }}" >> $GITHUB_ENV

      - name: Download IPA from release
        run: |
          gh release download "$TAG" --repo "$REPO" --pattern "*.ipa"
          IPA_NAME=$(ls *.ipa)
          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV

      - name: Sign and change bundle ID
        run: |
          unzip "$IPA_NAME" -d unpacked
          APP_PATH=$(find unpacked/Payload -name "*.app" | head -n 1)
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $NEW_ID" "$APP_PATH/Info.plist"
          cd unpacked && zip -r ../signed.ipa Payload

      - name: Upload signed IPA back to release
        run: |
          mv signed.ipa "$IPA_NAME"
          gh release upload "$TAG" "$IPA_NAME" --clobber --repo "$REPO"
