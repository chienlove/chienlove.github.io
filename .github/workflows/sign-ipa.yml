name: Sign IPA and Reupload

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag ch·ª©a IPA"
        required: true
      identifier:
        description: "Bundle Identifier m·ªõi"
        required: true

jobs:
  sign:
    runs-on: macos-latest
    permissions:
      contents: write  # C·∫ßn quy·ªÅn ghi ƒë·ªÉ upload release
      packages: read   # C·∫ßn quy·ªÅn ƒë·ªçc ƒë·ªÉ download IPA

    env:
      GH_TOKEN: ${{ github.token }}  # ƒê√£ thay th·∫ø GH_PAT b·∫±ng token t·ª± ƒë·ªông
      REPO: ${{ github.repository }}
      SUPABASE_URL: https://zkbzykamrzvvrhodiypk.supabase.co
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install tools
        run: |
          brew install curl jq gh
          echo "‚úÖ Tools installed successfully"

      - name: Validate environment variables
        run: |
          echo "üîç Validating environment variables..."
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "::error::‚ùå SUPABASE_SERVICE_ROLE_KEY is missing"
            exit 1
          fi
          if [ -z "$GH_TOKEN" ]; then
            echo "::error::‚ùå GH_TOKEN is missing"
            exit 1
          fi
          echo "‚úÖ Environment variables validated"

      - name: Fetch cert info from Supabase
        id: get_certs
        run: |
          echo "üì° Fetching certificates from Supabase..."
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Accept: application/json" \
            "${SUPABASE_URL}/rest/v1/certificates?select=*")

          http_status=$(echo "$response" | grep HTTP_STATUS: | cut -d':' -f2)
          json_data=$(echo "$response" | sed '/HTTP_STATUS/d')

          if [ "$http_status" -ne 200 ]; then
            echo "::error::‚ùå Supabase API returned $http_status"
            echo "Response: $json_data"
            exit 1
          fi

          cert_count=$(echo "$json_data" | jq length)
          if [ "$cert_count" -eq 0 ]; then
            echo "::error::‚ùå No certificates found in database"
            exit 1
          fi

          echo "$json_data" | jq '.[0]' > cert.json
          echo "üìÑ Certificate data saved"

          # Validate required fields
          p12_url=$(jq -r '.p12_url' cert.json)
          provision_url=$(jq -r '.provision_url' cert.json)
          password=$(jq -r '.password' cert.json)

          if [ -z "$p12_url" ] || [ -z "$provision_url" ] || [ -z "$password" ]; then
            echo "::error::‚ùå Missing required certificate fields"
            exit 1
          fi

          echo "CERT_P12_URL=$p12_url" >> $GITHUB_ENV
          echo "CERT_PROVISION_URL=$provision_url" >> $GITHUB_ENV
          echo "CERT_PASSWORD=$password" >> $GITHUB_ENV
          echo "‚úÖ Certificate info loaded"

      - name: Download certificates
        run: |
          set -e
          echo "‚¨áÔ∏è Downloading certificates..."
          curl -L -f "$CERT_P12_URL" -o cert.p12 || { 
            echo "::error::‚ùå Failed to download p12 file from $CERT_P12_URL"
            exit 1
          }
          curl -L -f "$CERT_PROVISION_URL" -o profile.mobileprovision || {
            echo "::error::‚ùå Failed to download provisioning profile from $CERT_PROVISION_URL"
            exit 1
          }
          echo "‚úÖ Certificates downloaded"

      - name: Set build variables
        run: |
          echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          echo "NEW_ID=${{ github.event.inputs.identifier }}" >> $GITHUB_ENV
          echo "‚öôÔ∏è Variables set: TAG=${{ github.event.inputs.tag }}, NEW_ID=${{ github.event.inputs.identifier }}"

      - name: Verify Release Exists
        run: |
          echo "üîç Checking release $TAG..."
          gh release view "$TAG" --repo "$REPO" || {
            echo "::error::‚ùå Release $TAG not found"
            exit 1
          }
          echo "‚úÖ Release $TAG exists"

      - name: Download IPA from release
        run: |
          set -e
          echo "‚¨áÔ∏è Downloading IPA from release $TAG..."
          gh release download "$TAG" \
            --repo "$REPO" \
            --pattern "*.ipa" \
            --clobber || {
              echo "::error::‚ùå Failed to download IPA from release $TAG"
              echo "Debug info:"
              gh release view "$TAG" --repo "$REPO"
              exit 1
            }
          IPA_NAME=$(ls *.ipa)
          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV
          echo "‚úÖ Downloaded IPA: $IPA_NAME"

      - name: Sign and change bundle ID
        run: |
          set -e
          echo "üì¶ Unpacking IPA..."
          unzip -q "$IPA_NAME" -d unpacked || { 
            echo "::error::‚ùå Failed to unzip IPA"
            exit 1
          }
          
          APP_PATH=$(find unpacked/Payload -name "*.app" -maxdepth 2 -print -quit)
          if [ -z "$APP_PATH" ]; then
            echo "::error::‚ùå Could not find .app bundle in IPA"
            exit 1
          fi
          echo "üìç Found app at: $APP_PATH"

          echo "üÜî Changing bundle ID to $NEW_ID"
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $NEW_ID" "$APP_PATH/Info.plist" || {
            echo "::error::‚ùå Failed to modify Info.plist"
            exit 1
          }

          echo "üì¶ Repacking IPA..."
          cd unpacked && zip -qr ../signed.ipa Payload || {
            echo "::error::‚ùå Failed to repack IPA"
            exit 1
          }
          echo "‚úÖ IPA repacked successfully"

      - name: Upload signed IPA back to release
        run: |
          set -e
          echo "‚¨ÜÔ∏è Uploading signed IPA..."
          mv signed.ipa "$IPA_NAME"
          gh release upload "$TAG" "$IPA_NAME" \
            --repo "$REPO" \
            --clobber || {
              echo "::error::‚ùå Failed to upload signed IPA to release $TAG"
              exit 1
            }
          echo "üéâ Upload completed successfully"