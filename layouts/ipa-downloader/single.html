{{ define "head" }}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ "css/ipadown.css" | relURL }}?{{ now.Unix }}">
{{ end }}
{{ define "main" }}
<h1>{{ .Title }}</h1>
<link rel="stylesheet" href="/css/ipadown.css">
<form id="download-form">
  <input type="text" id="appid" name="appid" placeholder="APPID hoặc URL Appstore" required>
  <input type="text" id="appVerId" name="appVerId" placeholder="ID phiên bản (không bắt buộc)">
  <input type="email" id="apple-id" name="apple-id" placeholder="Apple ID" required>
  <input type="password" id="password" name="password" placeholder="Mật khẩu" required>
  <input type="text" id="code" name="code" placeholder="Mã xác minh 2 bước (nếu có)">
  <button type="submit">Tải xuống IPA</button>
</form>
<div id="result"></div>

<script>
  document.getElementById("download-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    const resultDiv = document.getElementById("result");
    
    resultDiv.innerHTML = "Đang xử lý...";
    
    try {
      const response = await fetch("https://ipa-downloader.boypink93.workers.dev", {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP error! status: ${response.status}. Response: ${errorText}`);
      }
      
      const result = await response.json();
      if (result.url) {
        resultDiv.innerHTML = `<a href="${result.url}">Tải xuống IPA</a>`;
      } else {
        throw new Error("Không nhận được URL tải xuống");
      }
    } catch (error) {
      resultDiv.innerHTML = `Lỗi: ${error.message}`;
    }
  });
</script>
{{ end }}