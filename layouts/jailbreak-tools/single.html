{{ define "head" }}
<link rel="stylesheet" href="/css/jailbreak-tools.css?v={{ now.Unix }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{{ end }}

{{ define "main" }}
<div class="app-detail-container">
  <!-- Header Card -->
  <div class="app-card app-header-card">
    <div class="app-icon-wrapper">
      <img src="{{ .Params.icon }}" alt="{{ .Title }} Icon" class="app-icon-large">
    </div>
    <div class="app-header-content">
      <h1 class="app-title">{{ .Title }}</h1>
      <div class="app-meta">
        <span class="app-version-text">Version: {{ .Params.main_download.version }}</span>
        <span>Developer: {{ with .Params.developer }}{{ . }}{{ else }}Unknown{{ end }}</span>
      </div>
      {{ if .Params.main_download }}
      <a href="/download?appId={{ .Params.main_download.appId }}" class="download-btn">
        <i class="fas fa-download"></i> Download
      </a>
      {{ end }}
    </div>
  </div>

  <div class="app-content-layout">
    <!-- Left Column -->
    <div class="app-left-column">
      <!-- Description Card -->
      <div class="app-card">
        <h2 class="card-title">Description</h2>
        <div class="description-content">
          {{ $description := .Params.description | markdownify | plainify }}
          {{ $words := split $description " " }}
          
          {{ if gt (len $words) 100 }}
            <div id="short-description">
              {{ range first 100 $words }}{{ . }} {{ end }}...
            </div>
            <div id="full-description">
              {{ $description }}
            </div>
            <button class="toggle-description" onclick="toggleDescription()">
              <span id="toggle-text">Read more</span> <i class="fas fa-chevron-down"></i>
            </button>
          {{ else }}
            <div>{{ $description }}</div>
          {{ end }}
        </div>
      </div>

      <!-- Other Versions Card -->
      {{ if .Params.other_versions }}
      <div class="app-card">
        <h2 class="card-title">Other Versions</h2>
        <div class="versions-list">
          {{ range .Params.other_versions }}
          <div class="version-row">
            <span class="version-text">{{ $.Title }} {{ .version }}</span>
            <a href="/download?appId={{ .appId }}" class="version-download-icon">
              <i class="fas fa-download"></i>
            </a>
          </div>
          {{ end }}
        </div>
      </div>
      {{ end }}
    </div>

    <!-- Right Column -->
    <div class="app-right-column">
      <!-- Details Card -->
      <div class="app-card details-card">
        <h2 class="card-title">Details</h2>
        <div class="details-list">
          <div class="detail-row">
            <span class="detail-label">Developer:</span>
            <span class="detail-value">{{ with .Params.developer }}{{ . }}{{ else }}Unknown{{ end }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Category:</span>
            <span class="detail-value">{{ with .Params.categories }}{{ index . 0 }}{{ else }}Unknown{{ end }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Size:</span>
            <span class="detail-value">{{ with .Params.size }}{{ . }}{{ else }}Unknown{{ end }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">iOS Version:</span>
            <span class="detail-value">{{ with .Params.ios_compatible }}{{ . }}{{ else }}Unknown{{ end }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Last Updated:</span>
            <span class="detail-value">{{ .Lastmod.Format "January 2, 2006" }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Related Apps Section -->
  {{ $currentPage := . }}
  {{ $related := where (where .Site.RegularPages "Type" "jailbreak-tools") "File.Path" "!=" $currentPage.File.Path }}
  {{ if $related }}
  <div class="app-card">
    <h2 class="card-title">More Jailbreak Tools</h2>
    
    <!-- Pagination Variables -->
    {{ $paginate := 6 }}
    {{ $relatedCount := len $related }}
    {{ $pagesCount := div (add $relatedCount (sub $paginate 1)) $paginate }}
    
    <!-- Get Page Parameter or Default to 1 -->
    {{ $currentPageNum := 1 }}
    {{ with $.Scratch.Get "page" }}
      {{ $currentPageNum = . }}
    {{ else }}
      {{ with $.URL | relURL | strings.TrimPrefix "/" | strings.Split "?page=" }}
        {{ if ge (len .) 2 }}
          {{ $pageParam := index . 1 | int }}
          {{ if gt $pageParam 0 }}
            {{ $currentPageNum = $pageParam }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    <!-- Calculate Start and End Indexes -->
    {{ $start := mul (sub $currentPageNum 1) $paginate }}
    {{ $end := min (add $start $paginate) $relatedCount }}
    
    <!-- Display Current Page of Items -->
    <div class="related-apps-list">
      {{ range (first (sub $end $start) (after $start $related)) }}
      <div class="related-app-item">
        <a href="{{ .Permalink }}" class="app-link">
          <img src="{{ .Params.icon | default "/images/default-icon.png" }}" alt="{{ .Title }}" class="app-icon-small">
          <div class="app-item-content">
            <h3 class="app-title">{{ .Title }}</h3>
            <div class="app-meta-info">
              <span class="app-developer">{{ .Params.developer | default "Unknown developer" }}</span>
              <span class="app-version">v{{ .Params.main_download.version }}</span>
            </div>
          </div>
        </a>
        <a href="{{ .Permalink }}" class="related-download-icon">
          <i class="fas fa-download"></i>
        </a>
      </div>
      {{ end }}
    </div>
    
    <!-- Pagination Controls -->
    {{ if gt $pagesCount 1 }}
    <div class="pagination">
      <!-- Previous Button -->
      {{ if gt $currentPageNum 1 }}
        {{ $prevPageNum := sub $currentPageNum 1 }}
        <a href="?page={{ $prevPageNum }}" class="page-link prev-page">
          <i class="fas fa-chevron-left"></i> Previous
        </a>
      {{ else }}
        <span class="page-link prev-page disabled">
          <i class="fas fa-chevron-left"></i> Previous
        </span>
      {{ end }}
      
      <!-- Page Numbers -->
      <div class="page-numbers">
        {{ range $i := seq 1 $pagesCount }}
          {{ if eq $i $currentPageNum }}
          <span class="page-number current">{{ $i }}</span>
          {{ else }}
          <a href="?page={{ $i }}" class="page-number">{{ $i }}</a>
          {{ end }}
        {{ end }}
      </div>
      
      <!-- Next Button -->
      {{ if lt $currentPageNum $pagesCount }}
        {{ $nextPageNum := add $currentPageNum 1 }}
        <a href="?page={{ $nextPageNum }}" class="page-link next-page">
          Next <i class="fas fa-chevron-right"></i>
        </a>
      {{ else }}
        <span class="page-link next-page disabled">
          Next <i class="fas fa-chevron-right"></i>
        </span>
      {{ end }}
    </div>
    {{ end }}
  </div>
  {{ end }}

<script>
  // Toggle description function
  function toggleDescription() {
    const shortDesc = document.getElementById('short-description');
    const fullDesc = document.getElementById('full-description');
    const toggleBtn = document.querySelector('.toggle-description');
    
    if (fullDesc.style.display === 'none' || !fullDesc.style.display) {
      shortDesc.style.display = 'none';
      fullDesc.style.display = 'block';
      toggleBtn.innerHTML = '<span id="toggle-text">Show less</span> <i class="fas fa-chevron-up"></i>';
      toggleBtn.classList.add('expanded');
    } else {
      shortDesc.style.display = 'block';
      fullDesc.style.display = 'none';
      toggleBtn.innerHTML = '<span id="toggle-text">Read more</span> <i class="fas fa-chevron-down"></i>';
      toggleBtn.classList.remove('expanded');
    }
  }
</script>

<style>
  /* Pagination Styles */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 20px;
    gap: 10px;
  }
  
  .page-link {
    display: inline-flex;
    align-items: center;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 4px;
    color: #007bff;
    text-decoration: none;
    transition: all 0.2s;
  }
  
  .page-link:hover {
    background: #e9ecef;
  }
  
  .page-link.disabled {
    color: #adb5bd;
    pointer-events: none;
    cursor: default;
  }
  
  .page-numbers {
    display: flex;
    gap: 5px;
  }
  
  .page-number {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 4px;
    background: #f8f9fa;
    color: #495057;
    text-decoration: none;
  }
  
  .page-number:hover {
    background: #e9ecef;
  }
  
  .page-number.current {
    background: #007bff;
    color: white;
  }
</style>
{{ end }}