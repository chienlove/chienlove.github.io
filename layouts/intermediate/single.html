{{ define "main" }}
<h1>{{ .Title }}</h1>
<div id="app-info">
  <!-- Nội dung động sẽ được điền vào đây bởi JavaScript -->
  <div id="countdown"></div>
</div>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const appId = urlParams.get('appId');
  if (appId) {
    document.getElementById('app-info').innerHTML = `
      <p>App ID: ${appId}</p>
      <p>Loading...</p>
    `;
    let countdown = 10;
    const interval = setInterval(function() {
      countdown--;
      document.getElementById('countdown').innerText = countdown;
      if (countdown <= 0) {
        clearInterval(interval);
        fetch(`/.netlify/functions/download?appId=${appId}`)
          .then(response => {
            if (response.ok) {
              const redirectUrl = response.headers.get('Location');
              if (redirectUrl) {
                window.location.href = `itms-services://?action=download-manifest&url=${encodeURIComponent(redirectUrl)}`;
              } else {
                document.getElementById('countdown').innerText = "Error: Download link not found!";
              }
            } else {
              throw new Error('Network response was not ok.');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            document.getElementById('countdown').innerText = "Error: Unable to download!";
          });
      }
    }, 1000);
  } else {
    document.getElementById('app-info').innerHTML = "<p>Error: App ID not found!</p>";
  }
</script>
{{ end }}