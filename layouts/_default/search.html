<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tìm kiếm</title>
    <style>
        #search-box {
            width: 100%;
            padding: 10px;
            font-size: 18px;
            margin-bottom: 20px;
        }
        #autocomplete-results {
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
        }
        #autocomplete-results li {
            list-style-type: none;
            padding: 8px;
            cursor: pointer;
        }
        #autocomplete-results li:hover {
            background-color: #f0f0f0;
        }
        #search-results li {
            list-style-type: none;
            margin-bottom: 10px;
        }
        #search-results li a {
            text-decoration: none;
            color: blue;
        }
    </style>
</head>
<body>

<section>
    <h1>Tìm kiếm</h1>
    <input type="text" id="search-box" placeholder="Nhập từ khóa tìm kiếm..." autocomplete="off" />
    <ul id="autocomplete-results"></ul>
    <div>
        <h2>Kết quả tìm kiếm</h2>
        <ul id="search-results"></ul>
    </div>
</section>

<script src="https://unpkg.com/lunr/lunr.js"></script>
<script>
    let idx;
    let data;

    // Lấy dữ liệu JSON từ file index.json
    fetch('/index.json')
        .then(response => response.json())
        .then(jsonData => {
            data = jsonData;
            // Tạo chỉ mục tìm kiếm Lunr.js
            idx = lunr(function () {
                this.ref('url');
                this.field('title');
                this.field('content');
                this.field('tags');
                
                jsonData.forEach(function (doc) {
                    this.add(doc);
                }, this);
            });
        });

    const searchBox = document.getElementById('search-box');
    const autocompleteResults = document.getElementById('autocomplete-results');

    // Khi người dùng nhập vào ô tìm kiếm
    searchBox.addEventListener('input', function () {
        const query = searchBox.value.trim();
        if (query.length < 2) {
            autocompleteResults.innerHTML = '';  // Không gợi ý nếu từ khóa quá ngắn
            return;
        }

        const results = idx.search(query);

        // Hiển thị gợi ý tự hoàn thành (autocomplete)
        autocompleteResults.innerHTML = results.map(result => {
            const ref = result.ref;
            const item = data.find(d => d.url === ref);
            return `<li data-url="${item.url}">${item.title}</li>`;
        }).join('');

        // Gắn sự kiện khi người dùng chọn một gợi ý
        document.querySelectorAll('#autocomplete-results li').forEach(item => {
            item.addEventListener('click', function () {
                searchBox.value = this.textContent;
                performSearch();
                autocompleteResults.innerHTML = '';  // Ẩn danh sách gợi ý sau khi chọn
            });
        });
    });

    // Khi người dùng nhấn Enter, thực hiện tìm kiếm
    searchBox.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    // Hàm thực hiện tìm kiếm và hiển thị kết quả
    function performSearch() {
        const query = searchBox.value.trim();
        if (!query) {
            document.getElementById('search-results').innerHTML = "<li>Vui lòng nhập từ khóa để tìm kiếm</li>";
            return;
        }
        const results = idx.search(query);

        if (results.length > 0) {
            // Hiển thị kết quả tìm kiếm
            document.getElementById('search-results').innerHTML = results.map(result => {
                const ref = result.ref;
                const item = data.find(d => d.url === ref);
                return `<li><a href="${item.url}">${item.title}</a></li>`;
            }).join('');
        } else {
            document.getElementById('search-results').innerHTML = "<li>Không tìm thấy kết quả phù hợp</li>";
        }
    }
</script>

</body>
</html>